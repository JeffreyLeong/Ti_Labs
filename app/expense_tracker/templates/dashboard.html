{% extends "base.html" %}

{% block content %}
<h1>Expense Tracker Dashboard</h1>

<div class="records-container" id="transactions">
    {% for tx in transactions %}
    <div class="record-card" id="tx-{{ tx.id }}">
        <p><strong>{{ tx.date }}</strong></p>
        <p>{{ tx.description }}</p>
        <p>${{ tx.amount }}</p>
        <p>{{ tx.category_obj.name }} | {{ tx.type }}</p>
        <button class="delete-btn" data-id="{{ tx.id }}">Delete</button>
    </div>
    {% endfor %}
</div>

<div class="center-nav">
    <button class="btn nav-link" id="show-add-form">Add Record</button>
    <a href="{{ url_for('expense_tracker.view_all') }}" class="btn nav-link">View All Transactions</a>
</div>

<div id="add-form" class="form-container nice-form" style="display:none;">
    <form id="addRecordForm">
    <h2>Add Transaction</h2>

    <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date">
    </div>

    <div class="form-group">
        <label for="description">Description</label>
        <input type="text" id="description">
    </div>

    <div class="form-group">
        <label for="amount">Amount</label>
        <input type="number" step="0.01" id="amount">
    </div>

    <div class="form-group">
        <label for="category">Category</label>
        <select id="category" required>
            <option value="">Select Category</option>
            {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="type">Type</label>
        <select id="type">
            <option value="" selected>Select Type</option>
            <option value="Income">Income</option>
            <option value="Expense">Expense</option>
        </select>
    </div>

    <div class="form-actions">
        <button class="btn nav-link" id="submit-add">Submit</button>
        <button class="btn-secondary" id="cancel-add">Cancel</button>
    </div>
</form>
</div>

<script>
const showFormBtn = document.getElementById("show-add-form");
const addForm = document.getElementById("add-form");
const cancelBtn = document.getElementById("cancel-add");
const submitBtn = document.getElementById("submit-add");
const transactionsDiv = document.getElementById("transactions");

// Toggle Add Form
showFormBtn.addEventListener("click", () => addForm.style.display = "block");
cancelBtn.addEventListener("click", () => addForm.style.display = "none");

// Submit New Transaction via AJAX
submitBtn.addEventListener("click", (event) => {
    event.preventDefault();
    const data = {
        date: document.getElementById("date").value,
        description: document.getElementById("description").value,
        amount: document.getElementById("amount").value,
        category_id: document.getElementById("category").value,
        type: document.getElementById("type").value
    };

    // Frontend validation
    if (!data.category_id) {
        alert("Please select a category");
        return;
    }

    if (!data.type) {
        alery("please select a type");
        return;
    }

    fetch("{{ url_for('expense_tracker.add_record') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(tx => {
        const card = document.createElement("div");
        card.className = "record-card";
        card.id = "tx-" + tx.id;
        card.innerHTML = `
            <p><strong>${tx.date}</strong></p>
            <p>${tx.description}</p>
            <p>$${tx.amount}</p>
            <p>${tx.category} | ${tx.type}</p>
            <button class="delete-btn" data-id="${tx.id}">Delete</button>
        `;
        transactionsDiv.prepend(card);

        document.getElementById("addRecordForm").reset();

        addForm.style.display = "none";

        card.querySelector(".delete-btn").addEventListener("click", deleteTransaction);
    });
});

// Delete Transaction
function deleteTransaction(event) {
    const btn = event.target;
    const txId = btn.getAttribute("data-id");

    fetch(`/expense_tracker/delete/${txId}`, {method: "DELETE"})
    .then(res => res.json())
    .then(res => {
        if(res.success) {
            document.getElementById("tx-" + txId).remove();
        }
    });
}

// Attach delete listeners on page load
document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", deleteTransaction);
});
</script>
{% endblock %}
